---
title: "ER_intratumor_heterogeneity_clinical_analysis"
author: "Nigel Ultee"
date: "2024-01-03"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: true
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, warning=FALSE, message=FALSE)
```

```{r install and load packages}
required_packages <- c("fs", "openxlsx", "haven", "readxl", "stringr", "ggplot2",
                       "dplyr", "hrbrthemes", "tableone", "survival", "mgcv", 
                       "rms", "survminer", "rsample", "tidymodels")
install_packages <- required_packages[!(required_packages %in% installed.packages()[,"Package"])]
if(length(install_packages)) install.packages(install_packages)

library(fs)
library(openxlsx)
library(haven)
library(readxl)
library(stringr)
library(ggplot2)
library(dplyr)
library(hrbrthemes)
library(tableone)
library(survival)
library(mgcv)
library(rms)
library(survminer)
library(rsample)
library(tidymodels)
```

```{r custom functions}
str.return.number <- function (string, identification, pattern){
  # string: str, string of interest
  # identification: str, detect string of interest
  # pattern = regex, pattern to detect (specific) number within string
  # returns number of interest within string
  value = ifelse(startsWith(string, identification), 
                 as.numeric(str_extract(string, pattern)), 
                 NA)
  return(value)
}

add.id <- function(vector){
  # vector: vector that needs ID column
  # returns data frame with ID and values 
  return(data.frame(ID=deparse(substitute(vector)), value=vector))
}
```

```{r paths}
working_dir <- fs::path("R:/Groups/GroupLinn/Nigel/Projects/Intratumor heterogeneity/")
input_dir <- fs::path(working_dir, "Data slides/")
output_dir <- fs::path(working_dir, "Figures/")
```

### Density plots
```{r load data}
# CFMPB39 = IKA TAMOX 
# (max) stain scores per TMA core
ika_tma_fn = "CFMPB39_IKA_TAMOX_TMAscores_joined ER PR HER2 Beelen.xls"
ika_tma <- readxl::read_xls(fs::path(input_dir, ika_tma_fn))

# extract ER, PR and HER2 scoring
ika_tma[ika_tma < 0] <- NA
ika_er <- lapply(ika_tma[,c("ER1", "ER2", "ER3")], function(x) as.numeric(x)) 
ika_er <- as.numeric(unlist(ika_er))
ika_pr <- lapply(ika_tma[,c("PR1", "PR2", "PR3")], function(x) as.numeric(x)) 
ika_pr <- as.numeric(unlist(ika_pr))
ika_her2 <- lapply(ika_tma[,c("HER2_1", "HER2_2", "HER2_3")], function(x) as.numeric(x)) 
ika_her2 <- as.numeric(unlist(ika_her2))

### CFMPB173 = PARADIGM 
paradigm_tma_fn = "CFMPB173_PARADIGM_20231117 PARADIGM Nigel ER whole slides.xlsx"
paradigm_tma <- openxlsx::read.xlsx(fs::path(input_dir, paradigm_tma_fn), sheet = 3)


# extract ER, PR and HER2 scoring
paradigm_er <- lapply(paradigm_tma[,c("ER1", "ER2", "ER3")], function(x) as.numeric(x)) 
paradigm_er <- as.numeric(unlist(paradigm_er))
paradigm_pr <- lapply(paradigm_tma[,c("PR1", "PR2", "PR3")], function(x) as.numeric(x)) 
paradigm_pr <- as.numeric(unlist(paradigm_pr))
paradigm_her2 <- lapply(paradigm_tma[,c("HER2_1", "HER2_2", "HER2_3")], 
                        function(x) str.return.number(x, identification="IHC-", pattern="[0-9]"))
paradigm_her2 <- as.numeric(unlist(paradigm_her2))
```

TMAs available for:  
IKA - `r dim(ika_tma)[1]` patients.  
PARADIGM - `r dim(paradigm_tma)[1]` patients.

```{r density plots IHC4}
#pdf(file=fs::path(output_dir,"Distribution_IHC4.pdf"))
# ER
er_data <- bind_rows(add.id(ika_er), add.id(paradigm_er))
er_data %>%
  ggplot(aes(value, color=ID)) + 
  geom_density(size=2)
```

<button class="btn btn-primary" data-toggle="collapse" data-target="Hist ER"> Show/Hide </button>  
<div id="Hist ER" class="collapse"> 
```{r}
er_data %>%
  ggplot(aes(value, fill=ID)) + 
  geom_histogram(position="stack", bins=10)
```
</div>

```{r}
# PR   
pr_data <- bind_rows(add.id(ika_pr), add.id(paradigm_pr))
pr_data %>%
  ggplot(aes(value, color=ID)) + 
  geom_density(size=2)
```

<button class="btn btn-primary" data-toggle="collapse" data-target="RFS paradigm patient characteristics"> Show/Hide </button>  
<div id="RFS paradigm patient characteristics" class="collapse"> 
```{r}
pr_data %>%
  ggplot(aes(value, fill=ID)) + 
  geom_histogram(position="stack", bins=10)
```
</div>

```{r}
# HER2
her2_data <- bind_rows(add.id(ika_her2), add.id(paradigm_her2))
her2_data %>%
  ggplot(aes(value, color=ID)) + 
  geom_density(size=2)
```

<button class="btn btn-primary" data-toggle="collapse" data-target="HER2 hist"> Show/Hide </button>  
<div id="HER2 hist" class="collapse"> 
```{r}
her2_data %>%
  ggplot(aes(value, fill=ID)) + 
  geom_histogram(position="stack", bins=4)
```
</div>



```{r}
# Data from slidescore
# Name ; nr WSI HE; nr WSI ER; nr TMA ER; nr WSI HER2; nr TMA HER2; nr WSI Ki67; nr TMA Ki67
# CFMPB173 = PARADIGM; 318; 64; 185; 39; 188; 39; 101; 64
# CFMPB39 = IKA TAMOX; 797; 16; 14; 11; 0; 8; 0 ; 18
# IRBm22-293 = MINDACT; ?; ?; ?; ?; ?; ?; ?; ?
# TCGA; 
# ICGC; 
### add PR status?
```

### Patient characteristics
Simplify code -> keep all variables in original ika/paradigm data
#### IKA
```{r}
# CFMPB39 = IKA TAMOX 
ika_characteristics_fn = "CFMPB39_IKA_TAMOX_Final database_for PI3K_060112_withpSGK3_and4EBP1.sav"
ika_characteristics <- read_sav(fs::path(input_dir, ika_characteristics_fn))

# append missing variables
ika_extra <- read.delim(fs::path(input_dir, "KWF preliminary 20231002 1.txt"),
                        sep = ";", dec=",")
ika_extra <- ika_extra[match(ika_characteristics$TAMnr, ika_extra$TAMnr), ]
extra_vars <- c("age", "T", "chir2", "Prior.RT")
tma_vars <- c("ER_max", "PR_max", "HER2_max")
ika_characteristics <- data.frame(ika_characteristics, ika_extra[,extra_vars], 
                                  ika_tma)

# preprocessing
characteristics <- c("age", "T", "nodfinalrecoded", "grade", 
                     "histologie", "ER_max", "PR_max", "HER2_max", "KI67", 
                     "RFIevent", "RFIdays", "arm1recoded")
ika_general <- ika_characteristics[, characteristics[1:9]]
names(ika_general) <- c("Age", "Tumor size", "Nodal status", "Grade", 
                        "Histology", "ER percentage", "PR percentage", 
                        "HER2 score", "KI67 percentage")
ika_general$`Tumor size` <- as.character(ika_general$`Tumor size`)
ika_general$`Nodal status` <- replace(x=as.vector(ika_general$`Nodal status`),
                                      which(ika_general$`Nodal status` == 0),
                                      values = "Negative")
ika_general$`Nodal status` <- replace(x=as.vector(ika_general$`Nodal status`),
                                      which(ika_general$`Nodal status` == 1),
                                      values = "Positive")
ika_general$Grade <- as.character(ika_general$Grade)
ika_general$`Grade` <- replace(x=as.vector(ika_general$`Grade`),
                               which(ika_general$`Grade` == "0"),
                               values = NA)
ika_general$`Histology` <- replace(x=as.vector(ika_general$`Histology`),
                                   which(ika_general$`Histology` == 1),
                                   values = "No special type")
ika_general$`Histology` <- replace(x=as.vector(ika_general$`Histology`),
                                   which(ika_general$`Histology` == 2),
                                   values = "Lobular")
ika_general$`Histology` <- replace(x=as.vector(ika_general$`Histology`),
                                   which(ika_general$`Histology` > 2 & 
                                           ika_general$Histology <= 8),
                                   values = "Other")
ika_general$`Histology` <- replace(x=as.vector(ika_general$`Histology`),
                                   which(ika_general$`Histology` == 999),
                                   values = NA)
ika_general$`ER percentage` <- replace(x=as.vector(ika_general$`ER percentage`),                                         
                                       which(ika_general$`ER percentage` <= 1),
                                       values = " <=1")
ika_general$`ER percentage` <- replace(x=as.vector(ika_general$`ER percentage`),
                                       which(ika_general$`ER percentage` > 1 &
                                                 ika_general$`ER percentage` <= 10),
                                       values = "1-10")
ika_general$`ER percentage` <- replace(x=as.vector(ika_general$`ER percentage`),
                                       which(ika_general$`ER percentage` > 10),
                                       values = ">10")
ika_general$`PR percentage` <- replace(x=as.vector(ika_general$`PR percentage`),
                                       which(ika_general$`PR percentage` <= 1),
                                       values = " <=1")
ika_general$`PR percentage` <- replace(x=as.vector(ika_general$`PR percentage`),
                                       which(ika_general$`PR percentage` > 1 &
                                               ika_general$`PR percentage` <= 10),
                                       values = "1-10")
ika_general$`PR percentage` <- replace(x=as.vector(ika_general$`PR percentage`),
                                       which(ika_general$`PR percentage` > 10),
                                       values = ">10")
ika_general$`HER2 score` <- as.character(ika_general$`HER2 score`)
ika_general$`KI67 percentage` <- replace(x=as.vector(ika_general$`KI67 percentage`),
                                         which(ika_general$`KI67 percentage` <= 20),
                                         values = "0-20")
ika_general$`KI67 percentage` <- replace(x=as.vector(ika_general$`KI67 percentage`),
                                         which(ika_general$`KI67 percentage` > 20 &
                                                 ika_general$`KI67 percentage` <= 30),
                                         values = "20-30")
ika_general$`KI67 percentage` <- replace(x=as.vector(ika_general$`KI67 percentage`),
                                         which(ika_general$`KI67 percentage` > 30),
                                         values = ">30")
```

<button class="btn btn-primary" data-toggle="collapse" data-target="IKA patient characteristics"> Show/Hide </button>  
<div id="IKA patient characteristics" class="collapse"> 
```{r create table ika}
# https://www.rdocumentation.org/packages/tableone/versions/0.12.0/topics/CreateTableOne
ika_table <- CreateTableOne(data = ika_general, 
                            vars = c("Age", "Tumor size", "Grade", 
                                     "Histology","Nodal status", "ER percentage", 
                                     "PR percentage", "HER2 score",
                                     "KI67 percentage"),
                            #factorVars = c("Tumor size", "HER2 score"),
                            includeNA = FALSE
)

save_ika_table <- print(ika_table, nonnormal = c("Age"), formatOptions = list(big.mark = ","))

write.xlsx(as.data.frame(save_ika_table), file = fs::path(output_dir, "IKA_patient_characteristics.xlsx"))
write.csv(as.data.frame(save_ika_table), file = fs::path(output_dir, "IKA_patient_characteristics.csv"))
```
</div>

```{r}
print(save_ika_table)
```

#### Paradigm
```{r}
paradigm_tma_fn <- "CFMPB173_PARADIGM_20231117 PARADIGM Nigel ER whole slides.xlsx"
paradigm_characteristics <- openxlsx::read.xlsx(fs::path(input_dir, paradigm_tma_fn), sheet = 2)

characteristics <- c("T_LEEFT", "Grade", "HISTOLOGICAL_SUBTYPErec", "ER.num",
                     "PR.num")
# missing: tumor size, nodal status, HER2 status, Ki67 status

paradigm_general <- paradigm_characteristics[, characteristics]
paradigm_general[,"Nodal status"] <- NA  # node positive were excluded
paradigm_general[,"KI67 status"] <- NA  # measurements not trustworthy

paradigm_fn <- "CFMPB173_PARADIGM_20231117 PARADIGM Nigel ER whole slides.xlsx"
paradigm <- openxlsx::read.xlsx(fs::path(input_dir, paradigm_tma_fn), sheet = 1)

# bin Tumor size
table(paradigm$T_PTNMT)  # occurences per category
paradigm$T_PTNMT_3bin <- replace(x=paradigm$T_PTNMT,
                              which(paradigm$T_PTNMT == "1" |  # 62
                                      paradigm$T_PTNMT == "1A" |  # 87
                                      paradigm$T_PTNMT == "1B"),  # 331
                              values = "1-1B")
paradigm$T_PTNMT_3bin <- replace(x=paradigm$T_PTNMT_3bin,
                              which(paradigm$T_PTNMT_3bin == "2" |  # 618
                                      paradigm$T_PTNMT_3bin == "3" |  # 27
                                      paradigm$T_PTNMT_3bin == "4" |  # 2
                                      paradigm$T_PTNMT_3bin == "4B" |  # 5
                                      paradigm$T_PTNMT_3bin == "4D"),  # 1
                              values = "2-4D")  # 27
paradigm_general[,"Tumor size"] <- paradigm$T_PTNMT_3bin  # order=identical

paradigm_general <- paradigm_general[,c("T_LEEFT", "Tumor size", "Nodal status", 
                                        "Grade", "HISTOLOGICAL_SUBTYPErec", 
                                        "ER.num","PR.num", 
                                        "KI67 status")]
names(paradigm_general) <- c("Age", "Tumor size", "Nodal status", "Grade", 
                             "Histology", "ER percentage", "PR percentage",
                             "KI67 percentage")

paradigm_general$`Grade` <- replace(x=as.vector(paradigm_general$`Grade`),
                               which(paradigm_general$`Grade` == "Grade 1"),
                               values = "1")
paradigm_general$`Grade` <- replace(x=as.vector(paradigm_general$`Grade`),
                               which(paradigm_general$`Grade` == "Grade 2"),
                               values = "2")
paradigm_general$`Grade` <- replace(x=as.vector(paradigm_general$`Grade`),
                               which(paradigm_general$`Grade` == "Grade 3"),
                               values = "3")
paradigm_general$`Histology` <- replace(x=as.vector(paradigm_general$`Histology`),
                                   which(paradigm_general$`Histology` == "Carcinoma NOS"),
                                   values = "No special type")
paradigm_general$`Histology` <- replace(x=as.vector(paradigm_general$`Histology`),
                                   which(paradigm_general$`Histology` == "Lobular carcinoma"),
                                   values = "Lobular")
paradigm_general$`Histology` <- replace(x=as.vector(paradigm_general$`Histology`),
                                        which(paradigm_general$`Histology` != c("No special type", "Lobular")),
                                        values = "Other")
paradigm_general$`ER percentage` <- replace(x=as.vector(paradigm_general$`ER percentage`),
                                       which(paradigm_general$`ER percentage` <= 1),
                                       values = " <=1")
paradigm_general$`ER percentage` <- replace(x=as.vector(paradigm_general$`ER percentage`),
                                       which(paradigm_general$`ER percentage` > 1 &
                                               paradigm_general$`ER percentage` <= 10),
                                       values = "1-10")
paradigm_general$`ER percentage` <- replace(x=as.vector(paradigm_general$`ER percentage`),
                                       which(paradigm_general$`ER percentage` > 10),
                                       values = ">10")
paradigm_general$`PR percentage` <- replace(x=as.vector(paradigm_general$`PR percentage`),
                                       which(paradigm_general$`PR percentage` <= 1),
                                       values = " <=1")
paradigm_general$`PR percentage` <- replace(x=as.vector(paradigm_general$`PR percentage`),
                                       which(paradigm_general$`PR percentage` > 1 &
                                               paradigm_general$`PR percentage` <= 10),
                                       values = "1-10")
paradigm_general$`PR percentage` <- replace(x=as.vector(paradigm_general$`PR percentage`),
                                       which(paradigm_general$`PR percentage` > 10),
                                       values = ">10")
paradigm_general$`HER2 score` <- replace(x=as.vector(paradigm$HER2.rev),
                                          which(paradigm$HER2.rev == "IHC-0"),
                                          values = "0")
paradigm_general$`HER2 score` <- replace(x=as.vector(paradigm$HER2.rev),
                                          which(paradigm$HER2.rev == "IHC-1"),
                                          values = "1")
paradigm_general$`HER2 score` <- replace(x=as.vector(paradigm$HER2.rev),
                                          which(paradigm$HER2.rev == "IHC-2"),
                                          values = "2")
paradigm_general$`HER2 score` <- replace(x=as.vector(paradigm$HER2.rev),
                                          which(paradigm$HER2.rev == "IHC-3"),
                                          values = "3")
paradigm_general$`HER2 score` <- replace(x=as.vector(paradigm$HER2.rev),
                                          grep("SISH", paradigm$HER2.rev),
                                          values = NA)
```

<button class="btn btn-primary" data-toggle="collapse" data-target="Paradigm patient characteristics"> Show/Hide </button>  
<div id="Paradigm patient characteristics" class="collapse"> 
```{r create table paradigm}
# https://www.rdocumentation.org/packages/tableone/versions/0.12.0/topics/CreateTableOne
paradigm_table <- CreateTableOne(data = paradigm_general, 
                            vars = c("Age", "Tumor size", "Grade", 
                                     "Histology","Nodal status", "ER percentage", 
                                     "PR percentage", "HER2 score",
                                     "KI67 percentage"),
                            includeNA = FALSE
)

save_paradigm_table <- print(paradigm_table, nonnormal = c("Age"), formatOptions = list(big.mark = ","))

write.xlsx(as.data.frame(save_paradigm_table), file = fs::path(output_dir, "PARADIGM_patient_characteristics.xlsx"))
write.csv(as.data.frame(save_paradigm_table), file = fs::path(output_dir, "PARADIGM_patient_characteristics.csv"))

```
</div>

```{r}
print(save_paradigm_table)
```

### ER% - outcome Paradigm
```{r}
# extract variables
paradigm_fn <- "CFMPB173_PARADIGM_20231117 PARADIGM Nigel ER whole slides.xlsx"
paradigm <- openxlsx::read.xlsx(fs::path(input_dir, paradigm_tma_fn), sheet = 1)

# bin Tumor size
table(paradigm$T_PTNMT)  # occurences per category

paradigm$T_PTNMT_4bin <- replace(x=paradigm$T_PTNMT,
                              which(paradigm$T_PTNMT == "1" |  # 62
                                      paradigm$T_PTNMT == "1A" |  # 87
                                      paradigm$T_PTNMT == "1B"),  # 331
                              values = "1-1B")
paradigm$T_PTNMT_4bin <- replace(x=paradigm$T_PTNMT_4bin,
                              which(paradigm$T_PTNMT_4bin == "3" |  # 27
                                      paradigm$T_PTNMT_4bin == "4" |  # 2
                                      paradigm$T_PTNMT_4bin == "4B" |  # 5
                                      paradigm$T_PTNMT_4bin == "4D"),  # 1
                              values = "3-4D")  # 27
```

#### All histology types
##### OS (overall survival)
###### Cox proportional hazards
```{r OS cox}
paradigm$fustat.binary <- replace(x=paradigm$fustat.final,
                                which(paradigm$fustat.final == "in leven 0"),
                                values=0)
paradigm$fustat.binary <- replace(x=paradigm$fustat.binary,
                                 which(paradigm$fustat.binary == "overleden 1"),
                                 values=1)
surv_model <- coxph(Surv(VITFUP.final, as.numeric(fustat.binary)) ~ as.numeric(ER.num)+ T_LEEFT + Grade + T_PTNMT_4bin, 
                              data = paradigm)
summary(surv_model)
```

```{r OS cox 2}
surv_model <- coxph(Surv(VITFUP.final, as.numeric(fustat.binary)) ~ as.numeric(ER.num)+ T_LEEFT + Grade + T_PTNMT_4bin + ER.cat.final, 
                              data = paradigm)
summary(surv_model)
```
Correcting for ER status removes the independent prognostic value of the continuous ER score for tumors of all histological subtypes.

Assumptions  
Proportional hazards
<button class="btn btn-primary" data-toggle="collapse" data-target="OS prophaz"> Show/Hide </button>  
<div id="OS prophaz" class="collapse">  
```{r}
# test proportional hazards assumption
proportional_hazard_assumption <- cox.zph(surv_model)
print(proportional_hazard_assumption)
plot(proportional_hazard_assumption)
```
</div>

Linearity of log-hazards
<button class="btn btn-primary" data-toggle="collapse" data-target="OS log-haz"> Show/Hide </button>  
<div id="OS log-haz" class="collapse">  
```{r}
# test linearity of log-hazards
# gam_model <- mgcv::gam(Surv(VITFUP.final/365.25, as.numeric(fustat.binary)) ~ mgcv::s(as.numeric(ER.num)) + T_LEEFT + Grade + T_PTNMT_4bin, data = paradigm, family = "cox") # error invalid type list
# plot(gam_model)
```
</div>

Collinearity
<button class="btn btn-primary" data-toggle="collapse" data-target="OS collin"> Show/Hide </button>  
<div id="OS collin" class="collapse">  
```{r}
# test collinearity 
vif_values <- rms::vif(surv_model)
print(vif_values)
```
</div>

###### Kaplan-Meier
```{r binning}
# split 50-80
paradigm$ER_5080 <- replace(x=paradigm$ER.num,
                            which(as.numeric(paradigm$ER.num) <= 50),
                            values="1")
paradigm$ER_5080 <- replace(x=paradigm$ER_5080,
                            which(as.numeric(paradigm$ER_5080) > 50 &
                                    as.numeric(paradigm$ER_5080) <=80),
                            values="2")
paradigm$ER_5080 <- replace(x=paradigm$ER_5080,
                            which(as.numeric(paradigm$ER_5080) > 80),
                            values="3")

# split 0-50-80
paradigm$ER_5bin <- replace(x=paradigm$ER.num,
                            which(as.numeric(paradigm$ER.num) < 1),
                            values="0")
paradigm$ER_5bin <- replace(x=paradigm$ER_5bin,
                            which(as.numeric(paradigm$ER_5bin) >= 1 &
                                    as.numeric(paradigm$ER_5bin) <=10),
                            values="1")
paradigm$ER_5bin <- replace(x=paradigm$ER_5bin,
                            which(as.numeric(paradigm$ER_5bin) > 10 &
                                    as.numeric(paradigm$ER_5bin) <=50),
                            values="2")
paradigm$ER_5bin <- replace(x=paradigm$ER_5bin,
                            which(as.numeric(paradigm$ER_5bin) > 50 &
                                    as.numeric(paradigm$ER_5bin) <=80),
                            values="3")
paradigm$ER_5bin <- replace(x=paradigm$ER_5bin,
                            which(as.numeric(paradigm$ER_5bin) > 80),
                            values="4")

```

50-80 split
<button class="btn btn-primary" data-toggle="collapse" data-target="OS km1"> Show/Hide </button>  
<div id="OS km1" class="collapse">  
```{r OS Kaplan-Meier}
# Kaplan-Meier with OS
km_model <- survfit(Surv(VITFUP.final/365.25, as.numeric(fustat.binary)) ~ ER_5080, data = paradigm)
ggsurvplot(km_model, 
           data=paradigm,
           censor.shape = "|",
           censor.size = 1,
           fun="pct",
           palette = "lancet",
           risk.table = TRUE,
           risk.table.fontsize = 2.5,
           tables.height = 0.3,
           legend.title = "ER%",
           legend.labs =c("0-50%", "50-80%", "80-100%"),
           #conf.int=T,
           pval = TRUE,
           title = "Overall Survival",
           #ylim = c(40, 100),
           xlab = "Time (years)", 
           ylab = "Overall survival (%)",
           break.time.by = 5
)
```
</div>

1-10-50-80 split
```{r}
# kaplan-meier with OS (other groups)
km_model <- survfit(Surv(VITFUP.final/365.25, as.numeric(fustat.binary)) ~ ER_5bin, data = paradigm)
ggsurvplot(km_model, 
           data=paradigm,
           censor.shape = "|",
           censor.size = 1,
           fun="pct",
           palette = "lancet",
           risk.table = TRUE,
           risk.table.fontsize = 2.5,
           tables.height = 0.3,
           legend.title = "ER%",
           legend.labs =c("0", "1-10%", "11-50", "51-80%", "81-100%"),
           #conf.int=T,
           pval = TRUE,
           title = "Overall Survival",
           #ylim = c(40, 100),
           xlab = "Time (years)", 
           ylab = "Overall survival (%)",
           break.time.by = 5
)
```

##### RFS (recurrence free survival)
###### Cox proportional hazards
```{r RFS cox}
surv_model <- coxph(Surv(rfs.td, rfs.event) ~ as.numeric(ER.num) + T_LEEFT + Grade + T_PTNMT_4bin, 
                    data = paradigm)
summary(surv_model)
```


Proportional hazards
<button class="btn btn-primary" data-toggle="collapse" data-target="RFS prophaz"> Show/Hide </button>  
<div id="RFS prophaz" class="collapse">  
```{r RFS assumptions}
# test proportional hazards assumption
proportional_hazard_assumption <- cox.zph(surv_model)
print(proportional_hazard_assumption)
plot(proportional_hazard_assumption)
```
</div>

Linearity of log-hazards
<button class="btn btn-primary" data-toggle="collapse" data-target="RFS log-haz"> Show/Hide </button>  
<div id="RFS log-haz" class="collapse">  
```{r}
# test linearity of log-hazards
# gam_model <- mgcv::gam(Surv(rfs.td, rfs.event) ~ mgcv::s(as.numeric(ER.num)) + T_LEEFT + Grade + T_PTNMT_4bin, 
#                  data = paradigm, family = "cox") # error invalid type list
# plot(gam_model)
```
</div>

Collinearity
<button class="btn btn-primary" data-toggle="collapse" data-target="RFS collin"> Show/Hide </button>  
<div id="RFS collin" class="collapse">  
```{r}
# test collinearity 
vif_values <- rms::vif(surv_model)
print(vif_values)
```
</div>

###### Kaplan-Meier
50-80 split
<button class="btn btn-primary" data-toggle="collapse" data-target="RFS km1"> Show/Hide </button>  
<div id="RFS km1" class="collapse">  
```{r RFS Kaplan-Meier}
# kaplan-meier with RFS
km_model <- survfit(Surv(rfs.td/365.25, rfs.event) ~ ER_5080, data = paradigm)
ggsurvplot(km_model, 
           data=paradigm,
           censor.shape = "|",
           censor.size = 1,
           fun="pct",
           palette = "lancet",
           risk.table = TRUE,
           risk.table.fontsize = 2.5,
           tables.height = 0.3,
           legend.title = "ER%",
           legend.labs =c("0-50%", "50-80%", "80-100%"),
           #conf.int=T,
           pval = TRUE,
           title = "Recurrence free survival",
           #ylim = c(40, 100),
           xlab = "Time (years)", 
           ylab = "RFS event free (%)",
           break.time.by = 5
           )
```
</div>

1-10-50-80 split
```{r}
# kaplan-meier with RFS (other groups)
km_model <- survfit(Surv(rfs.td/365.25, rfs.event) ~ ER_5bin, data = paradigm)
ggsurvplot(km_model, 
           data=paradigm,
           censor.shape = "|",
           censor.size = 1,
           fun="pct",
           palette = "lancet",
           risk.table = TRUE,
           risk.table.fontsize = 2.5,
           tables.height = 0.3,
           legend.title = "ER%",
           legend.labs =c("0", "1-10%", "11-50", "51-80%", "81-100%"),
           #conf.int=T,
           pval = TRUE,
           title = "Recurrence free survival",
           #ylim = c(40, 100),
           xlab = "Time (years)", 
           ylab = "RFS event free (%)",
           break.time.by = 5
)
```

##### IDFS (invasive disease free survival)
```{r IDFS cox}
surv_model <- coxph(Surv(idfs.td, idfs) ~ as.numeric(ER.num)+ T_LEEFT + Grade + T_PTNMT_4bin, 
                    data = paradigm)
summary(surv_model)
```

###### Kaplan-Meier
50-80 split
<button class="btn btn-primary" data-toggle="collapse" data-target="IDFS km1"> Show/Hide </button>  
<div id="IDFS km1" class="collapse">  
```{r IDFS Kaplan-Meier, results='hide'}
# kaplan-meier with IDFS
km_model <- survfit(Surv(idfs.td/365.25, idfs) ~ ER_5080, data = paradigm)
ggsurvplot(km_model, 
           data=paradigm,
           censor.shape = "|",
           censor.size = 1,
           fun="pct",
           palette = "lancet",
           risk.table = TRUE,
           risk.table.fontsize = 2.5,
           tables.height = 0.3,
           legend.title = "ER%",
           legend.labs =c("0-50%", "50-80%", "80-100%"),
           #conf.int=T,
           pval = TRUE,
           title = "Invasive disease free survival",
           #ylim = c(40, 100),
           xlab = "Time (years)", 
           ylab = "RFS event free (%)",
           break.time.by = 5
           )
```
</div>

1-10-50-80 split
```{r, results='hide'}
# kaplan-meier with IDFS (other groups)
km_model <- survfit(Surv(idfs.td/365.25, idfs) ~ ER_5bin, data = paradigm)
ggsurvplot(km_model, 
           data=paradigm,
           censor.shape = "|",
           censor.size = 1,
           fun="pct",
           palette = "lancet",
           risk.table = TRUE,
           risk.table.fontsize = 2.5,
           tables.height = 0.3,
           legend.title = "ER%",
           legend.labs =c("0", "1-10%", "11-50", "51-80%", "80-100%"),
           #conf.int=T,
           pval = TRUE,
           title = "Invasive disease free survival",
           #ylim = c(40, 100),
           xlab = "Time (years)", 
           ylab = "RFS event free (%)",
           break.time.by = 5
)
```

#### Only ER+ HER2- tumors
```{r ER+ HER-}
paradigm_er_pos_her2_neg <- paradigm[paradigm$ER.cat.final=="Positive" & 
                                       paradigm$HER2.cat == "Negative",]
```

##### OS (overall survival)
###### Cox proportional hazards
```{r}
paradigm_er_pos_her2_neg$fustat.binary <- replace(x=paradigm_er_pos_her2_neg$fustat.final,
                                which(paradigm_er_pos_her2_neg$fustat.final == "in leven 0"),
                                values=0)
paradigm_er_pos_her2_neg$fustat.binary <- replace(x=paradigm_er_pos_her2_neg$fustat.binary,
                                 which(paradigm_er_pos_her2_neg$fustat.binary == "overleden 1"),
                                 values=1)
surv_model <- coxph(Surv(VITFUP.final, as.numeric(fustat.binary)) ~ as.numeric(ER.num)+ T_LEEFT + Grade + T_PTNMT_4bin, 
                              data = paradigm_er_pos_her2_neg)
summary(surv_model)
```
Within ER+ HER2- patients, the ER percentage as assessed by the pathologist is not independently prognostic either.

Assumptions  
Proportional hazards
<button class="btn btn-primary" data-toggle="collapse" data-target="OS prophaz 2"> Show/Hide </button>  
<div id="OS prophaz 2" class="collapse">  
```{r}
# test proportional hazards assumption
proportional_hazard_assumption <- cox.zph(surv_model)
print(proportional_hazard_assumption)
plot(proportional_hazard_assumption)
```
</div>

Linearity of log-hazards
<button class="btn btn-primary" data-toggle="collapse" data-target="OS log-haz 2"> Show/Hide </button>  
<div id="OS log-haz 2" class="collapse">  
```{r}
# test linearity of log-hazards
# gam_model <- mgcv::gam(Surv(VITFUP.final/365.25, as.numeric(fustat.binary)) ~ mgcv::s(as.numeric(ER.num)) + T_LEEFT + Grade + T_PTNMT_4bin, data = paradigm_er_pos_her2_neg, family = "cox") # error invalid type list
# plot(gam_model)
```
</div>

Collinearity
<button class="btn btn-primary" data-toggle="collapse" data-target="OS collin 2"> Show/Hide </button>  
<div id="OS collin 2" class="collapse">  
```{r}
# test collinearity 
vif_values <- rms::vif(surv_model)
print(vif_values)
```
</div>

###### Kaplan-Meier
50-80 split
<button class="btn btn-primary" data-toggle="collapse" data-target="OS km1 2"> Show/Hide </button>  
<div id="OS km1 2" class="collapse">  
```{r}
# Kaplan-Meier with OS
km_model <- survfit(Surv(VITFUP.final/365.25, as.numeric(fustat.binary)) ~ ER_5080, data = paradigm_er_pos_her2_neg)
ggsurvplot(km_model, 
           data=paradigm_er_pos_her2_neg,
           censor.shape = "|",
           censor.size = 1,
           fun="pct",
           palette = "lancet",
           risk.table = TRUE,
           risk.table.fontsize = 2.5,
           tables.height = 0.3,
           legend.title = "ER%",
           legend.labs =c("1-50%", "50-80%", "80-100%"),
           #conf.int=T,
           pval = TRUE,
           title = "Overall Survival",
           #ylim = c(40, 100),
           xlab = "Time (years)", 
           ylab = "Overall survival (%)",
           break.time.by = 5
)
```
</div>

1-10-50-80 split
```{r}
# kaplan-meier with OS (other groups)
km_model <- survfit(Surv(VITFUP.final/365.25, as.numeric(fustat.binary)) ~ ER_5bin, data = paradigm_er_pos_her2_neg)
ggsurvplot(km_model, 
           data=paradigm_er_pos_her2_neg,
           censor.shape = "|",
           censor.size = 1,
           fun="pct",
           palette = "lancet",
           risk.table = TRUE,
           risk.table.fontsize = 2.5,
           tables.height = 0.3,
           legend.title = "ER%",
           legend.labs =c("1-10%", "11-50", "51-80%", "81-100%"),
           #conf.int=T,
           pval = TRUE,
           title = "Overall Survival",
           ##ylim = c(40, 100),
           xlab = "Time (years)", 
           ylab = "Overall survival (%)",
           break.time.by = 5
)
```
Groups 1-10 and especially 81-100, seem to do better than groups 11-50 and 51-80, which, in principle, are more heterogeneous.
So taking these analyses together, can we conclude that it seems as if pathologists pick up some heterogeneity, but the ER percentage score is not independently prognostic. 
So the number of positive cells as scored by pathologists could possibly detect heterogeneity, however it does not seem to pick up the degree of heterogeneity (If ER percentage score takes only the number of cells into account and no other characteristics.) Now the question is, can we detect the degree of heterogeneity, if we add and combine characteristics as described in the paper by Lindstrom et. al i.e., richness x evenness(x intensity?) and eventually spatial relationships. 

Questions:  
- to Hugo: what characteristics do pathologist use to evaluate the ER (positive cell) percentage. Does it include intensity as well?

### Multivariable survival ER% bins (ER+HER2-)
```{r}
paradigm_er_pos_her2_neg$ER_4bin <- replace(x=paradigm_er_pos_her2_neg$ER.num,
                            which(as.numeric(paradigm_er_pos_her2_neg$ER.num) >= 1 &
                                    as.numeric(paradigm_er_pos_her2_neg$ER.num) <=10),
                            values="1-10")
paradigm_er_pos_her2_neg$ER_4bin <- replace(x=paradigm_er_pos_her2_neg$ER_4bin,
                            which(as.numeric(paradigm_er_pos_her2_neg$ER_4bin) > 10 &
                                    as.numeric(paradigm_er_pos_her2_neg$ER_4bin) <=50),
                            values="11-50")
paradigm_er_pos_her2_neg$ER_4bin <- replace(x=paradigm_er_pos_her2_neg$ER_4bin,
                            which(as.numeric(paradigm_er_pos_her2_neg$ER_4bin) > 50 &
                                    as.numeric(paradigm_er_pos_her2_neg$ER_4bin) <=80),
                            values="51-80")
paradigm_er_pos_her2_neg$ER_4bin <- replace(x=paradigm_er_pos_her2_neg$ER_4bin,
                            which(as.numeric(paradigm_er_pos_her2_neg$ER_4bin) > 80),
                            values="81-100")
```

```{r}
surv_model <- coxph(Surv(VITFUP.final, as.numeric(fustat.binary)) ~ ER_4bin+ T_LEEFT + Grade + T_PTNMT_4bin, 
                              data = paradigm_er_pos_her2_neg)
summary(surv_model)
```

#### without 1-10%
```{r}
paradigm_er_pos_her2_neg$ER_3bin <- replace(x=paradigm_er_pos_her2_neg$ER.num,
                            which(as.numeric(paradigm_er_pos_her2_neg$ER.num) > 10 &
                                    as.numeric(paradigm_er_pos_her2_neg$ER.num) <=50),
                            values="11-50")
paradigm_er_pos_her2_neg$ER_3bin <- replace(x=paradigm_er_pos_her2_neg$ER_3bin,
                            which(as.numeric(paradigm_er_pos_her2_neg$ER_3bin) > 50 &
                                    as.numeric(paradigm_er_pos_her2_neg$ER_3bin) <=80),
                            values="51-80")
paradigm_er_pos_her2_neg$ER_3bin <- replace(x=paradigm_er_pos_her2_neg$ER_3bin,
                            which(as.numeric(paradigm_er_pos_her2_neg$ER_3bin) > 80),
                            values="81-100")
paradigm_er_pos_her2_neg$ER_3bin <- replace(x=paradigm_er_pos_her2_neg$ER_3bin,
                            which(as.numeric(paradigm_er_pos_her2_neg$ER_3bin) <= 10),
                            values=NA)
```

```{r}
surv_model <- coxph(Surv(VITFUP.final, as.numeric(fustat.binary)) ~ ER_3bin + T_LEEFT + Grade + T_PTNMT_4bin, 
                              data = paradigm_er_pos_her2_neg)
summary(surv_model)
```

Assumptions  
Proportional hazards
<button class="btn btn-primary" data-toggle="collapse" data-target="OS prophaz 2"> Show/Hide </button>  
<div id="OS prophaz 2" class="collapse">  
```{r}
# test proportional hazards assumption
proportional_hazard_assumption <- cox.zph(surv_model)
print(proportional_hazard_assumption)
plot(proportional_hazard_assumption)
```
</div>

Linearity of log-hazards
<button class="btn btn-primary" data-toggle="collapse" data-target="OS log-haz 2"> Show/Hide </button>  
<div id="OS log-haz 2" class="collapse">  
```{r}
# test linearity of log-hazards
# gam_model <- mgcv::gam(Surv(VITFUP.final/365.25, as.numeric(fustat.binary)) ~ mgcv::s(as.numeric(ER.num)) + T_LEEFT + Grade + T_PTNMT_4bin, data = paradigm_er_pos_her2_neg, family = "cox") # error invalid type list
# plot(gam_model)
```
</div>

Collinearity
<button class="btn btn-primary" data-toggle="collapse" data-target="OS collin 2"> Show/Hide </button>  
<div id="OS collin 2" class="collapse">  
```{r}
# test collinearity 
vif_values <- rms::vif(surv_model)
print(vif_values)
```
</div>

#### 11-50 vs. 51-99 vs. 100
```{r}
paradigm_er_pos_her2_neg$ER_99bin <- replace(x=paradigm_er_pos_her2_neg$ER.num,
                            which(as.numeric(paradigm_er_pos_her2_neg$ER.num) > 10 &
                                    as.numeric(paradigm_er_pos_her2_neg$ER.num) <=50),
                            values="11-50")
paradigm_er_pos_her2_neg$ER_99bin <- replace(x=paradigm_er_pos_her2_neg$ER_99bin,
                            which(as.numeric(paradigm_er_pos_her2_neg$ER_99bin) > 50 &
                                    as.numeric(paradigm_er_pos_her2_neg$ER_99bin) <=99),
                            values="51-99")
paradigm_er_pos_her2_neg$ER_99bin <- replace(x=paradigm_er_pos_her2_neg$ER_99bin,
                            which(as.numeric(paradigm_er_pos_her2_neg$ER_99bin) > 99),
                            values="100")
paradigm_er_pos_her2_neg$ER_99bin <- replace(x=paradigm_er_pos_her2_neg$ER_99bin,
                            which(as.numeric(paradigm_er_pos_her2_neg$ER_99bin) <= 10),
                            values=NA)
```

```{r}
table(paradigm_er_pos_her2_neg$ER_99bin)
```

```{r}
surv_model <- coxph(Surv(VITFUP.final, as.numeric(fustat.binary)) ~ ER_99bin + T_LEEFT + Grade + T_PTNMT_4bin, 
                              data = paradigm_er_pos_her2_neg)
summary(surv_model)
```

Assumptions  
Proportional hazards
<button class="btn btn-primary" data-toggle="collapse" data-target="OS prophaz 2"> Show/Hide </button>  
<div id="OS prophaz 2" class="collapse">  
```{r}
# test proportional hazards assumption
proportional_hazard_assumption <- cox.zph(surv_model)
print(proportional_hazard_assumption)
plot(proportional_hazard_assumption)
```
</div>

Linearity of log-hazards
<button class="btn btn-primary" data-toggle="collapse" data-target="OS log-haz 2"> Show/Hide </button>  
<div id="OS log-haz 2" class="collapse">  
```{r}
# test linearity of log-hazards
# gam_model <- mgcv::gam(Surv(VITFUP.final/365.25, as.numeric(fustat.binary)) ~ mgcv::s(as.numeric(ER.num)) + T_LEEFT + Grade + T_PTNMT_4bin, data = paradigm_er_pos_her2_neg, family = "cox") # error invalid type list
# plot(gam_model)
```
</div>

Collinearity
<button class="btn btn-primary" data-toggle="collapse" data-target="OS collin 2"> Show/Hide </button>  
<div id="OS collin 2" class="collapse">  
```{r}
# test collinearity 
vif_values <- rms::vif(surv_model)
print(vif_values)
```
</div>

```{r}
# kaplan-meier with OS (other groups)
km_model <- survfit(Surv(VITFUP.final/365.25, as.numeric(fustat.binary)) ~ ER_99bin, data = paradigm_er_pos_her2_neg)
ggsurvplot(km_model, 
           data=paradigm_er_pos_her2_neg,
           censor.shape = "|",
           censor.size = 1,
           fun="pct",
           palette = "lancet",
           risk.table = TRUE,
           risk.table.fontsize = 2.5,
           tables.height = 0.3,
           legend.title = "ER%",
           legend.labs =c("11-50", "51-99", "100%"),
           #conf.int=T,
           pval = TRUE,
           title = "Overall Survival",
           #ylim = c(40, 100),
           xlab = "Time (years)", 
           ylab = "Overall survival (%)",
           break.time.by = 5
)
```

#### 11-99 vs. 100
```{r}
paradigm_er_pos_her2_neg$ER_2bin <- replace(x=paradigm_er_pos_her2_neg$ER.num,
                            which(as.numeric(paradigm_er_pos_her2_neg$ER.num) > 10 &
                                    as.numeric(paradigm_er_pos_her2_neg$ER.num) <=99),
                            values="11-99")
paradigm_er_pos_her2_neg$ER_2bin <- replace(x=paradigm_er_pos_her2_neg$ER_2bin,
                            which(as.numeric(paradigm_er_pos_her2_neg$ER_2bin) > 99),
                            values="100")
paradigm_er_pos_her2_neg$ER_2bin <- replace(x=paradigm_er_pos_her2_neg$ER_2bin,
                            which(as.numeric(paradigm_er_pos_her2_neg$ER_2bin) <= 10),
                            values=NA)
```

```{r}
table(paradigm_er_pos_her2_neg$ER_2bin)
```

```{r}
surv_model <- coxph(Surv(VITFUP.final, as.numeric(fustat.binary)) ~ ER_2bin + T_LEEFT + Grade + T_PTNMT_4bin, 
                              data = paradigm_er_pos_her2_neg)
summary(surv_model)
```

Assumptions  
Proportional hazards
<button class="btn btn-primary" data-toggle="collapse" data-target="OS prophaz 2"> Show/Hide </button>  
<div id="OS prophaz 2" class="collapse">  
```{r}
# test proportional hazards assumption
proportional_hazard_assumption <- cox.zph(surv_model)
print(proportional_hazard_assumption)
plot(proportional_hazard_assumption)
```
</div>

Linearity of log-hazards
<button class="btn btn-primary" data-toggle="collapse" data-target="OS log-haz 2"> Show/Hide </button>  
<div id="OS log-haz 2" class="collapse">  
```{r}
# test linearity of log-hazards
# gam_model <- mgcv::gam(Surv(VITFUP.final/365.25, as.numeric(fustat.binary)) ~ mgcv::s(as.numeric(ER.num)) + T_LEEFT + Grade + T_PTNMT_4bin, data = paradigm_er_pos_her2_neg, family = "cox") # error invalid type list
# plot(gam_model)
```
</div>

Collinearity
<button class="btn btn-primary" data-toggle="collapse" data-target="OS collin 2"> Show/Hide </button>  
<div id="OS collin 2" class="collapse">  
```{r}
# test collinearity 
vif_values <- rms::vif(surv_model)
print(vif_values)
```
</div>

```{r}
# kaplan-meier with OS (other groups)
km_model <- survfit(Surv(VITFUP.final/365.25, as.numeric(fustat.binary)) ~ ER_2bin, data = paradigm_er_pos_her2_neg)
ggsurvplot(km_model, 
           data=paradigm_er_pos_her2_neg,
           censor.shape = "|",
           censor.size = 1,
           fun="pct",
           palette = "lancet",
           risk.table = TRUE,
           risk.table.fontsize = 2.5,
           tables.height = 0.3,
           legend.title = "ER%",
           legend.labs =c("11-99", "100%"),
           #conf.int=T,
           pval = TRUE,
           title = "Overall Survival",
           #ylim = c(40, 100),
           xlab = "Time (years)", 
           ylab = "Overall survival (%)",
           break.time.by = 5
)
```

### Sampling
#### Proportional random sampling
```{r}
paradigm <- paradigm %>%
  mutate(
    Histology_3bin = case_when(
      HISTOLOGICAL_SUBTYPErec == "Carcinoma NST" ~ "No special type",
      HISTOLOGICAL_SUBTYPErec == "Lobular carcinoma" ~ "Lobular",
      TRUE ~ "Other"
    )
  )

# paradigm <- paradigm %>%
#      mutate(
#          Histology_3bin = case_when(
#              as.numeric(ER.num) == 0 ~ "0",
#              between(as.numeric(ER.num), 1, 10) ~ "1-10",
#              between(as.numeric(ER.num), 11, 50) ~ "11-50",
#              between(as.numeric(ER.num), 51, 80) ~ "51-80",
#              as.numeric(ER.num) > 80 ~ "81-100"
#          )
#      )

paradigm <- paradigm %>%
     mutate(
         ER_5bin = case_when(
             as.numeric(ER.num) == 0 ~ "0",
             between(as.numeric(ER.num), 1, 10) ~ "1-10",
             between(as.numeric(ER.num), 11, 50) ~ "11-50",
             between(as.numeric(ER.num), 51, 80) ~ "51-80",
             as.numeric(ER.num) > 80 ~ "81-100"
         )
     )

paradigm <- paradigm %>%
     mutate(
         PR_5bin = case_when(
             as.numeric(PR.num) == 0 ~ "0",
             between(as.numeric(PR.num), 1, 10) ~ "1-10",
             between(as.numeric(PR.num), 11, 50) ~ "11-50",
             between(as.numeric(PR.num), 51, 80) ~ "51-80",
             as.numeric(PR.num) > 80 ~ "81-100"
         )
     )
paradigm$rfs.event <- as.character(paradigm$rfs.event)
```


```{r}
set.seed(220120241)
```

```{r}
# "T_PTNMT_3bin", "ER.cat.final", "PR.cat.final", "fustat.binary"
variables_to_stratify <- c("Grade", "T_PTNMT", "rfs.event") 
#ignore_na <- c("Grade", "T_PTNMT", "TMA_NUMBER_ER_IHC_ER_E2_C2")

paradigm %>%
  #filter_at(vars(all_of(variables_to_stratify)), all_vars(!is.na(.))) %>%
  #filter(!any(is.na(across(all_of(variables_to_stratify))))) %>%
  group_by(across(all_of(variables_to_stratify))) %>%
  summarise(freq = n()) %>%
  as.data.frame()

# Calculate strata frequencies
strata_freq <- paradigm %>%
  #filter_at(vars(all_of(variables_to_stratify)), all_vars(!is.na(.))) %>%
  #filter(!any(is.na(across(all_of(variables_to_stratify))))) %>%
  group_by(across(all_of(variables_to_stratify))) %>%
  summarise(freq = n())

# add subgroups
paradigm_with_subgroups <- paradigm %>%
  #filter_at(vars(all_of(variables_to_stratify)), all_vars(!is.na(.))) %>%
  #filter(!any(is.na(across(all_of(variables_to_stratify))))) %>%
  group_by(across(all_of(variables_to_stratify))) %>%
  mutate(subgroup = group_indices()) %>%
  ungroup()

paradigm_with_subgroups <- paradigm_with_subgroups %>%
  left_join(strata_freq, by = c("Grade", "T_PTNMT")) %>%
  mutate(
    subgroup = as.numeric(as.character(subgroup)),
    probability = strata_freq$freq[match(subgroup, names(table(subgroup)))] / sum(strata_freq$freq)
  ) %>%
  select(-freq)  # Optional: Remove the freq column

stratify <- initial_split(paradigm_with_subgroups, prop=1/35, strata="subgroup")
stratified_proportions_sampled_data <- training(stratify)
```

```{r}
paradigm$sampled <- ifelse(paradigm$palga_nr %in% stratified_proportions_sampled_data$palga_nr, "yes", "no")

# https://www.rdocumentation.org/packages/tableone/versions/0.12.0/topics/CreateTableOne
sampled_table <- CreateTableOne(data = paradigm, 
                            vars = c("T_LEEFT", "T_PTNMT", "Grade", 
                                     "Histology_3bin", "ER_5bin", "PR_5bin", 
                                     "HER2.cat.rev.redone", "VITFUP.final", 
                                     "death.event", "fustat.binary", "rfs.event"
                                     ),
                            includeNA = FALSE,
                            strata = "sampled"
)

save_sampled_table <- print(sampled_table, nonnormal = c("T_LEEFT", "VITFUP.final"), formatOptions = list(big.mark = ","))

# write.xlsx(as.data.frame(save_paradigm_table), file = fs::path(output_dir, "PARADIGM_patient_characteristics.xlsx"))
# write.csv(as.data.frame(save_paradigm_table), file = fs::path(output_dir, "PARADIGM_patient_characteristics.csv"))
```
Excluding patients without ER TMA from the stratified sampling process might reduce the certainty of yielding a representative sample.
I would suggest to not filter for the presence of ER TMA. The nr of patients without TMA's for ER is `r sum(is.na(stratified_proportions_sampled_data$TMA_NUMBER_ER_IHC_ER_E2_C2))`.

#### Proportional random sampling ENRICHED 10-90%
```{r}
paradigm <- paradigm %>%
     mutate(
         ER_10bin = case_when(
             as.numeric(ER.num) == 0 ~ "0",
             between(as.numeric(ER.num), 1, 10) ~ "1-10",
             between(as.numeric(ER.num), 11, 20) ~ "11-20",
             between(as.numeric(ER.num), 21, 30) ~ "21-30",
             between(as.numeric(ER.num), 31, 40) ~ "31-40",
             between(as.numeric(ER.num), 41, 50) ~ "41-50",
             between(as.numeric(ER.num), 51, 60) ~ "51-60",
             between(as.numeric(ER.num), 61, 70) ~ "61-70",
             between(as.numeric(ER.num), 71, 80) ~ "71-80",
             between(as.numeric(ER.num), 81, 90) ~ "81-90",
             as.numeric(ER.num) > 90 ~ "91-100"
         )
     )

paradigm$rfs.event <- as.character(paradigm$rfs.event)
```

```{r}
set.seed(060220241)
```

```{r}
sample_from_bin <- function(data, binned_vars, size) {
  strata <- sort(na.omit(unique(data[[binned_vars]])))
  
  sampled_data <- lapply(strata, function(stratum) {
    bin_indices <- which(data[[binned_vars]] == stratum)
    sample_indices <- sample(bin_indices, size = size, replace = FALSE)
    return(data[sample_indices, , drop = FALSE])
  })
  
  return(do.call(rbind, sampled_data))
}
```

```{r}
random_bin_sample <- sample_from_bin(paradigm, binned_vars = "ER_10bin", size = 10)
```

```{r}
paradigm$sampled <- ifelse(paradigm$palga_nr %in% random_bin_sample$palga_nr, "yes", "no")

# https://www.rdocumentation.org/packages/tableone/versions/0.12.0/topics/CreateTableOne
sampled_table <- CreateTableOne(data = paradigm, 
                            vars = c("T_LEEFT", "T_PTNMT", "Grade", 
                                     "Histology_3bin", "ER_10bin", "PR_5bin", 
                                     "HER2.cat.rev.redone", "VITFUP.final", 
                                     "death.event", "fustat.binary", "rfs.event"
                                     ),
                            includeNA = TRUE,
                            strata = "sampled"
)

save_sampled_table <- print(sampled_table, nonnormal = c("T_LEEFT", "VITFUP.final"), formatOptions = list(big.mark = ","))

# write.xlsx(as.data.frame(save_paradigm_table), file = fs::path(output_dir, "PARADIGM_patient_characteristics.xlsx"))
# write.csv(as.data.frame(save_paradigm_table), file = fs::path(output_dir, "PARADIGM_patient_characteristics.csv"))
```

#### Proportional random sampling ENRICHED 10-90%, PROPORTIONAL
```{r}
set.seed(070220242)
```

```{r}
sample_from_bin_proportional <- function(data, binned_vars, size, variables_to_stratify) {
  # Calculate strata frequencies
  strata_freq <- data %>%
    #filter_at(vars(all_of(variables_to_stratify)), all_vars(!is.na(.))) %>%
    group_by(across(all_of(variables_to_stratify))) %>%
    summarise(freq = n())

  # Add subgroups
  data_with_subgroups <- data %>%
    #filter_at(vars(all_of(variables_to_stratify)), all_vars(!is.na(.))) %>%
    group_by(across(all_of(variables_to_stratify))) %>%
    mutate(subgroup = cur_group_id()) %>%
    ungroup()

  data_with_subgroups <- data_with_subgroups %>%
    left_join(strata_freq, by = variables_to_stratify) %>%
    mutate(
      subgroup = as.numeric(as.character(subgroup)),
      probability = strata_freq$freq[match(subgroup, names(table(subgroup)))] / sum(strata_freq$freq)
    ) %>%
    select(-freq)  # Optional: Remove the freq column
  
  # Check NAs in variables to stratify for each binned_vars
  bins <- sort(na.omit(unique(data[[binned_vars]])))
  for (bin_var in binned_vars){
    for (strat_var in variables_to_stratify){
      for (bin in bins){
        bin_indices <- which(data_with_subgroups[[bin_var]] == bin)
        non_na_data <- data_with_subgroups[bin_indices, strat_var]
        nas_in_non_na_bins <- length(which(is.na(non_na_data)))
        print(paste(strat_var, ": NAs in ", bin, " = ", nas_in_non_na_bins, sep=""))
      }
      na_bin_indices <- which(is.na(data_with_subgroups[ ,bin_var]))
      na_bin <- data_with_subgroups[na_bin_indices, strat_var]
      nas_na_bin <- length(which(is.na(na_bin)))
      total_nas <- length(which(is.na(data_with_subgroups[ , strat_var])))
      print(paste(nas_na_bin, "/", total_nas, " is NA in ", bin_var, " = NA", sep=""))
    }
  }
  
  # Sample from each stratum
  sampled_data <- lapply(bins, function(bin) {
    bin_indices <- which(data_with_subgroups[[binned_vars]] == bin)
    stratum_data <- data_with_subgroups[bin_indices, ]
    sample_indices <- sample(nrow(stratum_data), size = size, replace = FALSE, prob = stratum_data$probability)
    return(stratum_data[sample_indices, , drop = FALSE])
  })

  # Combine sampled data from each bin
  return(do.call(rbind, sampled_data))
}
```

```{r}
variables_to_stratify <- c("Grade", "rfs.event") # "T_PTNMT", "death.event"
random_bin_sample_proportional <- sample_from_bin_proportional(paradigm, binned_vars = "ER_10bin", size = 10, variables_to_stratify)
```

```{r}
paradigm$sampled <- ifelse(paradigm$palga_nr %in% random_bin_sample_proportional$palga_nr, "yes", "no")

# https://www.rdocumentation.org/packages/tableone/versions/0.12.0/topics/CreateTableOne
sampled_table <- CreateTableOne(data = paradigm, 
                            vars = c("T_LEEFT", "T_PTNMT", "Grade", 
                                     "Histology_3bin", "ER_10bin", "PR_5bin", 
                                     "HER2.cat.rev.redone", "VITFUP.final", 
                                     "death.event", "fustat.binary", "rfs.event"
                                     ),
                            includeNA = TRUE,
                            strata = "sampled"
)

save_sampled_table <- print(sampled_table, nonnormal = c("T_LEEFT", "VITFUP.final"), formatOptions = list(big.mark = ","))

# write.xlsx(as.data.frame(save_paradigm_table), file = fs::path(output_dir, "PARADIGM_patient_characteristics.xlsx"))
# write.csv(as.data.frame(save_paradigm_table), file = fs::path(output_dir, "PARADIGM_patient_characteristics.csv"))
```

Grade is disproportionally sampled. This is because whenever Grade=NA, then binned ER (ER_10bin)=NA for most cases.

#### Proportional random sampling ENRICHED 10-90%, PROPORTIONAL, IGNORE NAs
```{r}
set.seed(070220242)
```

```{r}
sample_from_bin_proportional <- function(data, binned_vars, size, variables_to_stratify) {
  # Calculate strata frequencies
  strata_freq <- data %>%
    #filter_at(vars(all_of(variables_to_stratify)), all_vars(!is.na(.))) %>%
    group_by(across(all_of(variables_to_stratify))) %>%
    summarise(freq = n())

  # Add subgroups
  data_with_subgroups <- data %>%
    #filter_at(vars(all_of(variables_to_stratify)), all_vars(!is.na(.))) %>%
    group_by(across(all_of(variables_to_stratify))) %>%
    mutate(subgroup = cur_group_id()) %>%
    ungroup()

  data_with_subgroups <- data_with_subgroups %>%
    left_join(strata_freq, by = variables_to_stratify) %>%
    mutate(
      subgroup = as.numeric(as.character(subgroup)),
      probability = strata_freq$freq[match(subgroup, names(table(subgroup)))] / sum(strata_freq$freq)
    ) %>%
    select(-freq)  # Optional: Remove the freq column
  
  # Check NAs in variables to stratify for each binned_vars
  bins <- sort(na.omit(unique(data[[binned_vars]])))
  for (bin_var in binned_vars){
    for (strat_var in variables_to_stratify){
      for (bin in bins){
        bin_indices <- which(data_with_subgroups[[bin_var]] == bin)
        non_na_data <- data_with_subgroups[bin_indices, strat_var]
        nas_in_non_na_bins <- length(which(is.na(non_na_data)))
        print(paste(strat_var, ": NAs in ", bin, " = ", nas_in_non_na_bins, sep=""))
      }
      na_bin_indices <- which(is.na(data_with_subgroups[ ,bin_var]))
      na_bin <- data_with_subgroups[na_bin_indices, strat_var]
      nas_na_bin <- length(which(is.na(na_bin)))
      total_nas <- length(which(is.na(data_with_subgroups[ , strat_var])))
      print(paste(nas_na_bin, "/", total_nas, " is NA in ", bin_var, " = NA", sep=""))
    }
  }
  
  # Sample from each stratum
  sampled_data <- lapply(bins, function(bin) {
    bin_indices <- which(data_with_subgroups[[binned_vars]] == bin)
    stratum_data <- data_with_subgroups[bin_indices, ]
    sample_indices <- sample(nrow(stratum_data), size = size, replace = FALSE, prob = stratum_data$probability)
    return(stratum_data[sample_indices, , drop = FALSE])
  })

  # Combine sampled data from each bin
  return(do.call(rbind, sampled_data))
}
```

```{r}
variables_to_stratify <- c("Grade", "death.event") # "T_PTNMT", "rfs.event"
random_bin_sample_proportional <- sample_from_bin_proportional(paradigm, binned_vars = "ER_10bin", size = 10, variables_to_stratify)
```

```{r}

paradigm$sampled <- ifelse(paradigm$palga_nr %in% random_bin_sample_proportional$palga_nr, "yes", "no")

# https://www.rdocumentation.org/packages/tableone/versions/0.12.0/topics/CreateTableOne
sampled_table <- CreateTableOne(data = paradigm, 
                            vars = c("T_LEEFT", "T_PTNMT", "Grade", 
                                     "Histology_3bin", "ER_10bin", "PR_5bin", 
                                     "HER2.cat.rev.redone", "death.event", 
                                     "rfs.event"
                                     ),
                            includeNA = FALSE,
                            strata = "sampled"
)

save_sampled_table <- print(sampled_table, nonnormal = c("T_LEEFT", "VITFUP.final"), formatOptions = list(big.mark = ","))


# write.xlsx(as.data.frame(save_paradigm_table), file = fs::path(output_dir, "PARADIGM_patient_characteristics.xlsx"))
# write.csv(save_paradigm_table, file = fs::path(output_dir, "PARADIGM_patient_characteristics.csv"))
temp_output_dir <- "C:/Users/n.ultee/PycharmProjects/ER_ITH_v1.0_python311_git/output_images/Clinical"
write.csv(save_paradigm_table, file = fs::path(temp_output_dir, "PARADIGM_patient_characteristics_WSI_SAMPLE.csv"))
```

Now the proportions of Grade are better.
```{r}
# Frequencies grade
ggplot(paradigm, aes(x = ER_10bin, fill = Grade)) +
  geom_bar(position = "stack") +
  labs(title = "Stacked Histogram of ER_10bin by Grade",
       x = "ER_10bin",
       y = "Frequency") +
  theme_minimal()
```


```{r}
# Relative frequencies grade
ggplot(paradigm, aes(x = ER_10bin, fill = Grade)) +
  geom_bar(position = "fill") +
  labs(title = "Stacked Histogram of ER_10bin by Grade (Relative Frequencies)",
       x = "ER_10bin",
       y = "Relative Frequency") +
  scale_y_continuous(labels = scales::percent_format()) +  # Display y-axis as percentages
  theme_minimal()
```
```{r}
excluded_categories <- c("0", "61-70", "71-80", "81-90", "91-100")

# Filter the data to exclude specified categories
filtered_data <- paradigm %>%
  filter(!ER_10bin %in% excluded_categories, !is.na(ER_10bin))

# Create the ggplot
ggplot(filtered_data, aes(x = ER_10bin, fill = Grade)) +
  geom_bar(position = "stack") +
  geom_text(
    aes(label = after_stat(count)),
    stat = "count",
    position = position_stack(vjust = 0.5),  # Adjust the vertical position of the labels
    color = "white", size = 3
  ) +
  labs(title = "Stacked Histogram of ER_10bin by Grade",
       x = "ER_10bin",
       y = "Frequency") +
  theme_minimal()
```
```{r}
# Grade distribution within ER% bins sampled population
ggplot(random_bin_sample_proportional, aes(x = ER_10bin, fill = Grade)) +
  geom_bar(position = "stack") +
  geom_text(
    aes(label = after_stat(count)),
    stat = "count",
    position = position_stack(vjust = 0.5),  # Adjust the vertical position of the labels
    color = "white", size = 3
  ) +
  labs(title = "Stacked Histogram of ER_10bin by Grade",
       x = "ER_10bin",
       y = "Frequency") +
  theme_minimal()
```

```{r}
# Retrieve T-numbers and Block numbers
split_strings <- str_split(random_bin_sample_proportional$TUMORSLIDE_ASSESSED_REVISION_E1_C1, "/") # Split the strings
patient_block_ids <- data.frame( 
  `T nummer` = sapply(split_strings, `[`, 1),
  `Bloknummer` = sapply(split_strings, `[`, 2),
  `PALGA nummer` = random_bin_sample_proportional$palga_nr,
  `TMA nummer` = random_bin_sample_proportional$TMA_NUMBER_ER_IHC_ER_E2_C2,
  `TMA redone` = random_bin_sample_proportional$ER_TMA_WHOLE_SLIDE_REDONE_IHC_ER_E2_C2
)

# Print the resulting data frame
write.xlsx(as.data.frame(patient_block_ids), file = fs::path(temp_output_dir, "PARADIGM_WSI_SAMPLE_Tnummer_Bloknummer.xlsx"))
```

```{r}
# Set the directory where your Excel files are located
excel_files_dir <- "R:/Groups/GroupLinn/Gwen/NKI/NBCP/YBCP/PALGA koppeling/PA-materiaal/TMA/TMA Grandmaster backup"

# Get a list of all Excel files starting with "CF" in the specified directory
file_list <- list.files(excel_files_dir, pattern = "^CF.*\\.xlsx$", full.names = TRUE)

# Check if any files are found
if (length(file_list) == 0) {
  stop("No files found with the specified pattern.")
}

# Create an empty data frame to store the combined data
combined_data <- data.frame()

# Loop through each file and read data into the combined_data data frame
for (file in file_list) {
  df <- read_excel(file)
  combined_data <- bind_rows(combined_data, df)
}
```

```{r}
no_tma <- data.frame(TUMORSLIDE_ASSESSED_REVISION_E1_C1 = character(),
                     TMA_NUMBER_ER_IHC_ER_E2_C2 = character(),
                     stringsAsFactors = FALSE)

for (value in random_bin_sample_proportional$TUMORSLIDE_ASSESSED_REVISION_E1_C1) {
  value_without_slash <- gsub("/", " ", value)
  
  if (value_without_slash %in% combined_data$`Donor Block ID`) {
    next
  } else {
    tumorslide <- random_bin_sample_proportional[random_bin_sample_proportional$TUMORSLIDE_ASSESSED_REVISION_E1_C1 == value, "TMA_NUMBER_ER_IHC_ER_E2_C2"]
    palganummer <- random_bin_sample_proportional[random_bin_sample_proportional$TUMORSLIDE_ASSESSED_REVISION_E1_C1 == value, "palga_nr"]
    
    # Append a new row to the data frame
    no_tma <- rbind(no_tma, data.frame(TUMORSLIDE_ASSESSED_REVISION_E1_C1 = value,
                                       TMA_NUMBER_ER_IHC_ER_E2_C2 = tumorslide,
                                       palga_nr = palganummer,
                                       stringsAsFactors = FALSE))
  }
}

# View the resulting data frame
print(no_tma)
```

#### Proportional random sampling ENRICHED 10-90%, PROPORTIONAL, IGNORE TMA==NA 
```{r}
set.seed(280220242)
```

```{r}
sample_from_bin_proportional <- function(data, binned_vars, size, variables_to_stratify, exclude_na_vars) {
  # Calculate strata frequencies
  strata_freq <- data %>%
    #filter_at(vars(all_of(variables_to_stratify)), all_vars(!is.na(.))) %>%
    group_by(across(all_of(variables_to_stratify))) %>%
    summarise(freq = n())

  # Add subgroups
  data_with_subgroups <- data %>%
    #filter_at(vars(all_of(variables_to_stratify)), all_vars(!is.na(.))) %>%
    group_by(across(all_of(variables_to_stratify))) %>%
    mutate(subgroup = cur_group_id()) %>%
    ungroup()

  data_with_subgroups <- data_with_subgroups %>%
    left_join(strata_freq, by = variables_to_stratify) %>%
    mutate(
      subgroup = as.numeric(as.character(subgroup)),
      probability = strata_freq$freq[match(subgroup, names(table(subgroup)))] / sum(strata_freq$freq)
    ) %>%
    select(-freq)  # Optional: Remove the freq column
  
  # Check NAs in variables to stratify for each binned_vars
  bins <- sort(na.omit(unique(data[[binned_vars]])))
  for (bin_var in binned_vars){
    for (strat_var in variables_to_stratify){
      for (bin in bins){
        bin_indices <- which(data_with_subgroups[[bin_var]] == bin)
        non_na_data <- data_with_subgroups[bin_indices, strat_var]
        nas_in_non_na_bins <- length(which(is.na(non_na_data)))
        print(paste(strat_var, ": NAs in ", bin, " = ", nas_in_non_na_bins, sep=""))
      }
      na_bin_indices <- which(is.na(data_with_subgroups[ ,bin_var]))
      na_bin <- data_with_subgroups[na_bin_indices, strat_var]
      nas_na_bin <- length(which(is.na(na_bin)))
      total_nas <- length(which(is.na(data_with_subgroups[ , strat_var])))
      print(paste(nas_na_bin, "/", total_nas, " is NA in ", bin_var, " = NA", sep=""))
    }
  }
  
  # Sample from each stratum
  sampled_data <- lapply(bins, function(bin) {
    bin_indices <- which(data_with_subgroups[[binned_vars]] == bin)
    stratum_data <- data_with_subgroups[bin_indices, ]

    # Exclude rows where specified variables are NA
    for (exclude_na_var in exclude_na_vars) {
      stratum_data <- stratum_data[complete.cases(stratum_data[, exclude_na_var]), ]
    }

    # Sample indices only from non-NA rows
    sample_indices <- sample(nrow(stratum_data), size = size, replace = FALSE, prob = stratum_data$probability)
    return(stratum_data[sample_indices, , drop = FALSE])
  })

  # Combine sampled data from each bin
  return(do.call(rbind, sampled_data))
}
```

```{r}
variables_to_stratify <- c("Grade", "death.event") # "T_PTNMT", "rfs.event"
random_bin_sample_proportional <- sample_from_bin_proportional(paradigm, binned_vars = "ER_10bin", size = 10, variables_to_stratify, exclude_na_vars = "TMA_NUMBER_ER_IHC_ER_E2_C2")
```

```{r}

paradigm$sampled <- ifelse(paradigm$palga_nr %in% random_bin_sample_proportional$palga_nr, "yes", "no")

# https://www.rdocumentation.org/packages/tableone/versions/0.12.0/topics/CreateTableOne
sampled_table <- CreateTableOne(data = paradigm, 
                            vars = c("T_LEEFT", "T_PTNMT", "Grade", 
                                     "Histology_3bin", "ER_10bin", "PR_5bin", 
                                     "HER2.cat.rev.redone", "death.event", 
                                     "rfs.event"
                                     ),
                            includeNA = FALSE,
                            strata = "sampled"
)

save_sampled_table <- print(sampled_table, nonnormal = c("T_LEEFT", "VITFUP.final"), formatOptions = list(big.mark = ","))


# write.xlsx(as.data.frame(save_paradigm_table), file = fs::path(output_dir, "PARADIGM_patient_characteristics.xlsx"))
# write.csv(save_paradigm_table, file = fs::path(output_dir, "PARADIGM_patient_characteristics.csv"))
temp_output_dir <- "C:/Users/n.ultee/PycharmProjects/ER_ITH_v1.0_python311_git/output_images/Clinical"
write.csv(save_paradigm_table, file = fs::path(temp_output_dir, "PARADIGM_patient_characteristics_WSI_SAMPLE.csv"))
```

##### Retrieve block numbers

```{r}
# Retrieve T-numbers and Block numbers
split_strings <- str_split(random_bin_sample_proportional$TUMORSLIDE_ASSESSED_REVISION_E1_C1, "/") # Split the strings
patient_block_ids <- data.frame( 
  `T nummer` = sapply(split_strings, `[`, 1),
  `Bloknummer` = sapply(split_strings, `[`, 2),
  `PALGA nummer` = random_bin_sample_proportional$palga_nr,
  `TMA nummer` = random_bin_sample_proportional$TMA_NUMBER_ER_IHC_ER_E2_C2,
  `TMA redone` = random_bin_sample_proportional$ER_TMA_WHOLE_SLIDE_REDONE_IHC_ER_E2_C2
)

# Print the resulting data frame
write.xlsx(as.data.frame(patient_block_ids), file = fs::path(temp_output_dir, "PARADIGM_WSI_SAMPLE_Tnummer_Bloknummer.xlsx"))
```

```{r}
# Set the directory where your Excel files are located
excel_files_dir <- "R:/Groups/GroupLinn/Gwen/NKI/NBCP/YBCP/PALGA koppeling/PA-materiaal/TMA/TMA Grandmaster backup"

# Get a list of all Excel files starting with "CF" in the specified directory
file_list <- list.files(excel_files_dir, pattern = "^CF.*\\.xlsx$", full.names = TRUE)

# Check if any files are found
if (length(file_list) == 0) {
  stop("No files found with the specified pattern.")
}

# Create an empty data frame to store the combined data
combined_data <- data.frame()

# Loop through each file and read data into the combined_data data frame
for (file in file_list) {
  df <- read_excel(file)
  combined_data <- bind_rows(combined_data, df)
}
```

```{r}
tma <- data.frame(TUMORSLIDE_ASSESSED_REVISION_E1_C1 = character(),
                     TMA_block = vector(),
                     stringsAsFactors = FALSE) # check cores >=1 ER% present in YBCP directly
no_tma <- data.frame(TUMORSLIDE_ASSESSED_REVISION_E1_C1 = character(),
                     TMA_NUMBER_ER_IHC_ER_E2_C2 = character(),
                     stringsAsFactors = FALSE) # find correct TMA nr and file in YBCP

for (value in random_bin_sample_proportional$TUMORSLIDE_ASSESSED_REVISION_E1_C1) {
  value_without_slash <- gsub("/", " ", value)
  palganummer <- random_bin_sample_proportional[random_bin_sample_proportional$TUMORSLIDE_ASSESSED_REVISION_E1_C1 == value, "palga_nr"]
  tumorslide <- random_bin_sample_proportional[random_bin_sample_proportional$TUMORSLIDE_ASSESSED_REVISION_E1_C1 == value, "TMA_NUMBER_ER_IHC_ER_E2_C2"]
  
  if (value_without_slash %in% combined_data$`Donor Block ID`) {
    occurence = unique(combined_data[combined_data$`Donor Block ID` %in% value_without_slash, "TMA Block ID"])
    tma <- rbind(tma, data.frame(TUMORSLIDE_ASSESSED_REVISION_E1_C1 = value_without_slash,
                                 TMA_NUMBER_ER_IHC_ER_E2_C2 = tumorslide,
                                 TMA_block = occurence,
                                 palganummer = palganummer,
                                 stringsAsFactors = FALSE)
      
    )
  } else {
    # Append a new row to the data frame
    no_tma <- rbind(no_tma, data.frame(TUMORSLIDE_ASSESSED_REVISION_E1_C1 = value,
                                       TMA_NUMBER_ER_IHC_ER_E2_C2 = tumorslide,
                                       palga_nr = palganummer,
                                       stringsAsFactors = FALSE))
  }
}

# View the resulting data frame
print(no_tma)
```

```{r}
# Find tumorslide assessed with multiple blocks
# Assuming your data frame is named df
multiple_blocks <- tma %>%
  group_by(TUMORSLIDE_ASSESSED_REVISION_E1_C1) %>%
  filter(n() >= 2) %>%
  ungroup()

# View the resulting data frame
print(multiple_blocks)
```

```{r}
variables <- c("TUMORSLIDE_ASSESSED_REVISION_E1_C1",
               "TMA_NUMBER_ER_IHC_ER_E2_C2",
               "palga_nr",
               "PERCENTAGE_OF_ER_POSITIVE_CELLS_CORE_1_IHC_ER_E2_C2", 
               "PERCENTAGE_OF_ER_POSITIVE_CELLS_CORE_2_IHC_ER_E2_C2",
               "PERCENTAGE_OF_ER_POSITIVE_CELLS_CORE_3_IHC_ER_E2_C2",
               "PERCENTAGE_OF_ER_POSITIVE_CELLS_CORE_1_REDONE_IHC_ER_E2_C2",
               "PERCENTAGE_OF_ER_POSITIVE_CELLS_CORE_2_REDONE_IHC_ER_E2_C2",
               "PERCENTAGE_OF_ER_POSITIVE_CELLS_CORE_3_REDONE_IHC_ER_E2_C2",
               "ER_TMA_WHOLE_SLIDE_IHC_ER_E2_C2",
               "ER_TMA_WHOLE_SLIDE_REDONE_IHC_ER_E2_C2" 
               )
# Which are redone
redone <- random_bin_sample_proportional[random_bin_sample_proportional$ER_REDONE_IHC_ER_E2_C2 == "Yes", variables]

# Which redone with whole slide
redone_whole_slide <- redone[redone$"ER_TMA_WHOLE_SLIDE_REDONE_IHC_ER_E2_C2" == "Whole slide", variables]
```

`r redone_whole_slide$palga_nr` do not have a tma present.

```{r}
# Find TMA in YBCP
# paradigm_tma_fn = "CFMPB173_PARADIGM_20231117 PARADIGM Nigel ER whole slides.xlsx"
# paradigm_tma <- openxlsx::read.xlsx(fs::path(input_dir, paradigm_tma_fn), sheet = 3)
unknown_tma <- redone[redone$"ER_TMA_WHOLE_SLIDE_REDONE_IHC_ER_E2_C2" != "Whole slide", variables]
ybcp_unknown_tma <- paradigm_tma[paradigm_tma$X1 %in% as.character(unknown_tma$palga_nr), ] # character

no_tma_er_non_na <- data.frame(
  TUMORSLIDE_ASSESSED = character(),
  TMA_NUMBER_ER = numeric(),
  palga_nr = character(),
  ER1 = numeric(),
  ER2 = numeric(),
  ER3 = numeric(),
  stringsAsFactors = FALSE
)

no_tma_er_not_non_na <- data.frame(
  TUMORSLIDE_ASSESSED = character(),
  TMA_NUMBER_ER = numeric(),
  palga_nr = character(),
  ER1 = numeric(),
  ER2 = numeric(),
  ER3 = numeric(),
  stringsAsFactors = FALSE
)

for (subject in unique(ybcp_unknown_tma$X1)) {
  instances <- ybcp_unknown_tma[ybcp_unknown_tma$X1 %in% subject, ]
  
  if (any(!is.na(instances[, c("ER1", "ER2", "ER3")]))) {
    no_tma_er_non_na <- rbind(no_tma_er_non_na, instances[, c("X3", "TMA", "X1", "ER1", "ER2", "ER3")])
  } else {
    no_tma_er_not_non_na <- rbind(no_tma_er_not_non_na, instances[, c("X3", "TMA", "X1", "ER1", "ER2", "ER3")])
  }
}



# Subset paradigm_tma using palga_nr (X1 in YBCP)
# Check some examples
```

#### Proportional random sampling ENRICHED 10-90%, PROPORTIONAL, IGNORE TMA==NA, IGNORE REDONE==WHOLE SLIDE 
```{r}
set.seed(010320242)
```

```{r}
sample_from_bin_proportional <- function(data, binned_vars, size, variables_to_stratify, exclude_na_vars, exclude_condition) {
  # Calculate strata frequencies
  strata_freq <- data %>%
    #filter_at(vars(all_of(variables_to_stratify)), all_vars(!is.na(.))) %>%
    group_by(across(all_of(variables_to_stratify))) %>%
    summarise(freq = n())

  # Add subgroups
  data_with_subgroups <- data %>%
    #filter_at(vars(all_of(variables_to_stratify)), all_vars(!is.na(.))) %>%
    group_by(across(all_of(variables_to_stratify))) %>%
    mutate(subgroup = cur_group_id()) %>%
    ungroup()

  data_with_subgroups <- data_with_subgroups %>%
    left_join(strata_freq, by = variables_to_stratify) %>%
    mutate(
      subgroup = as.numeric(as.character(subgroup)),
      probability = strata_freq$freq[match(subgroup, names(table(subgroup)))] / sum(strata_freq$freq)
    ) %>%
    select(-freq)  # Optional: Remove the freq column
  
  # Check NAs in variables to stratify for each binned_vars
  bins <- sort(na.omit(unique(data[[binned_vars]])))
  for (bin_var in binned_vars){
    for (strat_var in variables_to_stratify){
      for (bin in bins){
        bin_indices <- which(data_with_subgroups[[bin_var]] == bin)
        non_na_data <- data_with_subgroups[bin_indices, strat_var]
        nas_in_non_na_bins <- length(which(is.na(non_na_data)))
        print(paste(strat_var, ": NAs in ", bin, " = ", nas_in_non_na_bins, sep=""))
      }
      na_bin_indices <- which(is.na(data_with_subgroups[ ,bin_var]))
      na_bin <- data_with_subgroups[na_bin_indices, strat_var]
      nas_na_bin <- length(which(is.na(na_bin)))
      total_nas <- length(which(is.na(data_with_subgroups[ , strat_var])))
      print(paste(nas_na_bin, "/", total_nas, " is NA in ", bin_var, " = NA", sep=""))
    }
  }
  
  # Sample from each stratum
  sampled_data <- lapply(bins, function(bin) {
    bin_indices <- which(data_with_subgroups[[binned_vars]] == bin)
    stratum_data <- data_with_subgroups[bin_indices, ]

    # Exclude rows where specified variables are NA
    for (exclude_na_var in exclude_na_vars) {
      stratum_data <- stratum_data[complete.cases(stratum_data[, exclude_na_var]), ]
    }

    # Exclude rows based on the condition
    stratum_data <- with(stratum_data, stratum_data[!eval(exclude_condition), ])

    # Sample indices only from non-NA and non-excluded rows
    sample_indices <- sample(nrow(stratum_data), size = size, replace = FALSE, prob = stratum_data$probability)
    return(stratum_data[sample_indices, , drop = FALSE])
  })

  # Combine sampled data from each bin
  return(do.call(rbind, sampled_data))
}
```

```{r}
variables_to_stratify <- c("Grade", "death.event") # "T_PTNMT", "rfs.event"
exclude_condition <- quote(ER_TMA_WHOLE_SLIDE_IHC_ER_E2_C2 == "Whole slide")
random_bin_sample_proportional <- sample_from_bin_proportional(paradigm, binned_vars = "ER_10bin", 
                                                               size = 10, 
                                                               variables_to_stratify,
                                                               exclude_na_vars = "TMA_NUMBER_ER_IHC_ER_E2_C2", 
                                                               exclude_condition = exclude_condition
                                                               )


```

```{r}

paradigm$sampled <- ifelse(paradigm$palga_nr %in% random_bin_sample_proportional$palga_nr, "yes", "no")

# https://www.rdocumentation.org/packages/tableone/versions/0.12.0/topics/CreateTableOne
sampled_table <- CreateTableOne(data = paradigm, 
                            vars = c("T_LEEFT", "T_PTNMT", "Grade", 
                                     "Histology_3bin", "ER_10bin", "PR_5bin", 
                                     "HER2.cat.rev.redone", "death.event", 
                                     "rfs.event"
                                     ),
                            includeNA = FALSE,
                            strata = "sampled"
)

save_sampled_table <- print(sampled_table, nonnormal = c("T_LEEFT", "VITFUP.final"), formatOptions = list(big.mark = ","))


# write.xlsx(as.data.frame(save_paradigm_table), file = fs::path(output_dir, "PARADIGM_patient_characteristics.xlsx"))
# write.csv(save_paradigm_table, file = fs::path(output_dir, "PARADIGM_patient_characteristics.csv"))
temp_output_dir <- "C:/Users/n.ultee/PycharmProjects/ER_ITH_v1.0_python311_git/output_images/Clinical"
write.csv(save_paradigm_table, file = fs::path(temp_output_dir, "PARADIGM_patient_characteristics_WSI_SAMPLE.csv"))
```

##### Retrieve block numbers

```{r}
# Retrieve T-numbers and Block numbers
split_strings <- str_split(random_bin_sample_proportional$TUMORSLIDE_ASSESSED_REVISION_E1_C1, "/") # Split the strings
patient_block_ids <- data.frame( 
  `T nummer` = sapply(split_strings, `[`, 1),
  `Bloknummer` = sapply(split_strings, `[`, 2),
  `PALGA nummer` = random_bin_sample_proportional$palga_nr,
  `TMA nummer` = random_bin_sample_proportional$TMA_NUMBER_ER_IHC_ER_E2_C2,
  `TMA redone` = random_bin_sample_proportional$ER_TMA_WHOLE_SLIDE_REDONE_IHC_ER_E2_C2
)

# Print the resulting data frame
write.xlsx(as.data.frame(patient_block_ids), file = fs::path(temp_output_dir, "PARADIGM_WSI_SAMPLE_Tnummer_Bloknummer.xlsx"))
```

```{r}
# Set the directory where your Excel files are located
excel_files_dir <- "R:/Groups/GroupLinn/Gwen/NKI/NBCP/YBCP/PALGA koppeling/PA-materiaal/TMA/TMA Grandmaster backup"

# Get a list of all Excel files starting with "CF" in the specified directory
file_list <- list.files(excel_files_dir, pattern = "^CF.*\\.xlsx$", full.names = TRUE)

# Check if any files are found
if (length(file_list) == 0) {
  stop("No files found with the specified pattern.")
}

# Create an empty data frame to store the combined data
combined_data <- data.frame()

# Loop through each file and read data into the combined_data data frame
for (file in file_list) {
  df <- read_excel(file)
  combined_data <- bind_rows(combined_data, df)
}
```

```{r}
tma <- data.frame(TUMORSLIDE_ASSESSED_REVISION_E1_C1 = character(),
                     TMA_block = vector(),
                     stringsAsFactors = FALSE) # check cores >=1 ER% present in YBCP directly
no_tma <- data.frame(TUMORSLIDE_ASSESSED_REVISION_E1_C1 = character(),
                     TMA_NUMBER_ER_IHC_ER_E2_C2 = character(),
                     stringsAsFactors = FALSE) # find correct TMA nr and file in YBCP

for (value in random_bin_sample_proportional$TUMORSLIDE_ASSESSED_REVISION_E1_C1) {
  value_without_slash <- gsub("/", " ", value)
  palganummer <- random_bin_sample_proportional[random_bin_sample_proportional$TUMORSLIDE_ASSESSED_REVISION_E1_C1 == value, "palga_nr"]
  tumorslide <- random_bin_sample_proportional[random_bin_sample_proportional$TUMORSLIDE_ASSESSED_REVISION_E1_C1 == value, "TMA_NUMBER_ER_IHC_ER_E2_C2"]
  
  if (value_without_slash %in% combined_data$`Donor Block ID`) {
    occurence = unique(combined_data[combined_data$`Donor Block ID` %in% value_without_slash, "TMA Block ID"])
    tma <- rbind(tma, data.frame(TUMORSLIDE_ASSESSED_REVISION_E1_C1 = value_without_slash,
                                 TMA_NUMBER_ER_IHC_ER_E2_C2 = tumorslide,
                                 TMA_block = occurence,
                                 palganummer = palganummer,
                                 stringsAsFactors = FALSE)
      
    )
  } else {
    # Append a new row to the data frame
    no_tma <- rbind(no_tma, data.frame(TUMORSLIDE_ASSESSED_REVISION_E1_C1 = value,
                                       TMA_NUMBER_ER_IHC_ER_E2_C2 = tumorslide,
                                       palga_nr = palganummer,
                                       stringsAsFactors = FALSE))
  }
}

# View the resulting data frame
print(no_tma)
```

```{r}
# Find tumorslide assessed with multiple blocks
multiple_blocks <- tma %>%
  group_by(TUMORSLIDE_ASSESSED_REVISION_E1_C1) %>%
  filter(n() >= 2) %>%
  ungroup()

# View the resulting data frame
print(multiple_blocks)
```

```{r}
# Check if ER evaluation was feasible in any of the three cores
all_ids <- paradigm_tma[paradigm_tma$X1 %in% as.character(tma$palga_nr), "X1"] # character
unique_ids <- unique(all_ids)

tma_er_non_na <- data.frame()
tma_er_na <- data.frame()
for (palga_nr in unique_ids) {
  instances <- paradigm_tma[paradigm_tma$X1 %in% palga_nr, ]
  
  # Check if ER evaluation was feasible in any of the three cores
  if (any(!is.na(instances[, c("ER1", "ER2", "ER3")]))) {
    # numeric_values <- as.numeric(instances[, c("ER1", "ER2", "ER3")])
    numeric_values <- apply(instances[, c("ER1", "ER2", "ER3")], 2, as.numeric)
    if (!is.null(dim(numeric_values)) && nrow(numeric_values) > 0) {
      select_non_na <- apply(!is.na(numeric_values), 1, any)
      tma_er_non_na  <- rbind(tma_er_non_na, instances[select_non_na, c("X3", "TMA", "X1", "ER1", "ER2", "ER3")])
    } else {
      tma_er_non_na  <- rbind(tma_er_non_na, instances[, c("X3", "TMA", "X1", "ER1", "ER2", "ER3")])
    }
  } else {
    tma_er_na <- rbind(tma_er_na, instances[, c("X3", "TMA", "X1", "ER1", "ER2", "ER3")])
  }
}
```

 
```{r}
# Find TMA in YBCP
# paradigm_tma_fn = "CFMPB173_PARADIGM_20231117 PARADIGM Nigel ER whole slides.xlsx"
# paradigm_tma <- openxlsx::read.xlsx(fs::path(input_dir, paradigm_tma_fn), sheet = 3)
ybcp_unknown_tma <- paradigm_tma[paradigm_tma$X1 %in% as.character(no_tma$palga_nr), ] # character
duplicated <- ybcp_unknown_tma$X1[duplicated(ybcp_unknown_tma$X1)]

no_tma_er_non_na <- data.frame(
  TUMORSLIDE_ASSESSED = character(),
  TMA_NUMBER_ER = numeric(),
  palga_nr = character(),
  ER1 = numeric(),
  ER2 = numeric(),
  ER3 = numeric(),
  stringsAsFactors = FALSE
)

no_tma_er_not_non_na <- data.frame(
  TUMORSLIDE_ASSESSED = character(),
  TMA_NUMBER_ER = numeric(),
  palga_nr = character(),
  ER1 = numeric(),
  ER2 = numeric(),
  ER3 = numeric(),
  stringsAsFactors = FALSE
)

for (subject in unique(ybcp_unknown_tma$X1)) {
  instances <- ybcp_unknown_tma[ybcp_unknown_tma$X1 %in% subject, ]
  
  # Check if ER evaluation was feasible in any of the three cores
  if (any(!is.na(instances[, c("ER1", "ER2", "ER3")]))) {
    # numeric_values <- as.numeric(instances[, c("ER1", "ER2", "ER3")])
    numeric_values <- apply(instances[, c("ER1", "ER2", "ER3")], 2, as.numeric)
    if (!is.null(dim(numeric_values)) && nrow(numeric_values) > 0) {
      select_non_na <- apply(!is.na(numeric_values), 1, any)
      no_tma_er_non_na  <- rbind(no_tma_er_non_na, instances[select_non_na, c("X3", "TMA", "X1", "ER1", "ER2", "ER3")])
    } else {
      no_tma_er_non_na  <- rbind(no_tma_er_non_na, instances[, c("X3", "TMA", "X1", "ER1", "ER2", "ER3")])
    }
  } else {
    no_tma_er_non_na <- rbind(no_tma_er_non_na, instances[, c("X3", "TMA", "X1", "ER1", "ER2", "ER3")])
  }
}
```
`r duplicated` are duplicated.

```{r}
# Complete data 
match_palga <- match(tma_er_non_na$X1, tma$palga_nr)
tma_er_non_na$TUMORSLIDE_ASSESSED_REVISION_E1_C1 <- tma[match_palga, "TUMORSLIDE_ASSESSED_REVISION_E1_C1"]

match_palga <- match(no_tma_er_non_na$X1, no_tma$palga_nr)
no_tma_er_non_na$TUMORSLIDE_ASSESSED_REVISION_E1_C1 <- no_tma[match_palga, "TUMORSLIDE_ASSESSED_REVISION_E1_C1"]

if (all(names(tma_er_non_na) == names(no_tma_er_non_na))){
  complete_data <- rbind(tma_er_non_na, no_tma_er_non_na)
  names(complete_data)[1] <- "TMA_NUMBER_ER_IHC_ER_E2_C2"
  names(complete_data)[3] <- "palga_nr"
}
```

```{r}
open_first_excel_file <- function(excel_files, 
                                  identification_pattern,
                                  exclude_identification_pattern=NULL,
                                  sheetname = NULL, 
                                  colnames = FALSE
                                  ) {
  # Retrieve all files containing the identification pattern
  files_found <- excel_files[str_detect(excel_files, identification_pattern)]
  files_found <- files_found[!str_detect(files_found, exclude_identification_pattern)]
  
  print(files_found[1])
  
  # Check if there are any matching files
  if(length(files_found) > 0) {
    # Read the first matching file
    if (is.null(sheetname)) {
      # If sheetname is not provided, open the first sheet
      data <- read_excel(files_found[1])
    } else {
      data <- read_excel(files_found[1], sheet = sheetname, col_names = colnames)
    }
    return(list(file_path = files_found[1], data = data))
  } else {
    # cat("No matching files found in the specified directory.\n")
    return(NULL)
  }
}
```

```{r}
find_value_in_column <- function(palga_nr, tma_data, column_id, col_instance=1){
  # Find column with block id
  # col_names <- names(tma_data)[which(tma_data == column_id, arr.ind = TRUE)[, "col"]]
  
  col_indices <- sapply(tma_data, function(col) any(grepl(column_id, col)))
  col_names <- names(col_indices)[col_indices]
  
  if (length(unique(col_names)) == 1){
    row <- unique(which(tma_data == palga_nr, arr.ind = TRUE)[, "row"])
    if (is_empty(row)){
      value <- "Palga number not found"
    } else {
      value <- tma_data[row, unique(col_names)]
    }
  } else if(length(unique(col_names)) == 2){
    value <- tma_data[row, unique(col_names)[col_instance]]
  } else if(length(unique(col_names)) == 0) {
    value <- "No column contains column identification pattern."
  } else {
    value <- "Multiple columns found, try finding column with block ID manually."
  }
  
  return(as.character(value))
}
```

```{r}
has_sheet2 <- function(file_path) {
  sheets <- excel_sheets(file_path)
  "Sheet2" %in% sheets
}

# search_folder <- "C:/Users/n.ultee/Delete_test_folder"
search_folder <- "R:/Groups/GroupLinn/Gwen/NKI/NBCP/YBCP/Mark/CF173 TMA AR and phospho scores"
excel_files <- list.files(path = search_folder, pattern = "*.xlsx", full.names = TRUE)

# Identify files without "Sheet2"
files_without_sheet2 <- excel_files[!sapply(excel_files, has_sheet2)]
print(files_without_sheet2)
```

```{r}
# Retrieve block numbers
for (subject in 1:nrow(complete_data)){
  # Preprocess TMA ID
  palga_nr <- complete_data[subject, "palga_nr"]
  tma_number <- complete_data[subject, "TMA"]
  tma_number <- str_extract(tma_number, "(old\\d+|\\d+)")
  if (!startsWith(tma_number, "old")) {
    tma_number <- paste0("TMA", tma_number)
  }

  # Retrieve excel file
  exclude <- "-"
  file_data <- open_first_excel_file(excel_files, tma_number, exclude, "Sheet2")
  if (!is.null(file_data[1])){
    block_id1 <- find_value_in_column(palga_nr, file_data$data, column_id = "^[Aa]1$")
    block_id2 <- find_value_in_column(palga_nr, file_data$data, column_id = "^A$", col_instance = 2)
    # block_id1 <- find_value_in_column(palga_nr, file_data$data, column_id = "A1", col_instance = 1)
    # block_id2 <- find_value_in_column(palga_nr, file_data$data, column_id = "A", col_instance = 2)
  } else {
    block_id1 <- "Excel file not found"
    block_id2 <- "Excel file not found"
  }
  
  # Add Block ID
  complete_data[subject, "Block_ID1"] <- block_id1
  complete_data[subject, "Block_ID2"] <- block_id2
  if (!is.null(file_data$file_path)) {
  complete_data[subject, "File_name"] <- file_data$file_path
  }
}
```

```{r}
file_path <- fs::path(working_dir, "Data slides/Retrieve_blocks_paradigm_sample.xlsx")

# Check if the file already exists
if (file.exists(file_path)) {
  # Attempt to remove the existing file
  removal_result <- try(file.remove(file_path), silent = TRUE)
  
  if (inherits(removal_result, "try-error")) {
    cat("Failed to remove existing file. Error: ", conditionMessage(removal_result), "\n")
  } else if (removal_result) {
    print("Existing file removed successfully.")
  }
}

# Create excel form
write.xlsx(as.data.frame(complete_data), file = fs::path(working_dir, "Data slides/Retrieve_blocks_paradigm_sample.xlsx"))
write.csv(as.data.frame(complete_data), file = fs::path(working_dir, "Data slides/Retrieve_blocks_paradigm_sample.csv"))
```